***请注意，此纳伏特计设计已被新的更优设计所取代，该设计将很快在[this Github repository](https://github.com/jaromir-sukuba/nvm2)此存储库中公开。***


## 这个资料库里有什么？
这里包含了整套的设计文件、制造数据、源文件、测试结果以及其他我在构建纳伏特计的过程中所使用过的资源。这一过程并非偶然，而是对TiN在[他的网站](https://xdevs.com/article/nvm_comp/)上提出的纳伏特计挑战的回应。
![外部视图](/media/IMG_0002_.jpg?raw=true)


## 什么是纳伏特表，它有什么用？
好吧，纳伏是一种灵敏度、噪声和稳定性都能分辨低至纳伏特的电压的电压表。虽然许多万用表确实具有相当敏感的低压范围， 分辨率(最低有效数字)通常在数百纳伏特左右，而最后一个数字的值通常会因仪表的噪声和非线性而降低。因此，对于适当的低信号测量，必须有更高的灵敏度。
测量如此低的电压对许多应用都很有用，例如解决各种差分和桥式电路中的小电压差，以及使用适当的电流源测量非常小的电阻。
商用纳米电压表确实存在，如Keithley Model 2182A或Keysight 34420A，但价格高昂，因此DIY设计肯定有其一席之地。

## XDevs 挑战
尽管我一直在鼓捣DIY的测试和测量工具，但我从未萌生过探索纳伏特世界的冲动。这一契机发生在2021年9月2日，当时xdevs网站上的TiN发起了[纳伏特挑战](https://xdevs.com/article/nvm_comp/)。简而言之，该挑战呼吁设计一款开源纳伏特计，其参数需与商业设计相当，且需在256天内完成。这是一项非比寻常的任务，而对我而言，更是如此，因为在此之前我从未设计过低信号电路，也从未操作过纳伏特计。这确实是一个颇为不利的起始点，但我决定迎难而上，而不是浅尝辄止。为了让自己安心，我等待了几天，观察其他人在[eevblog论坛](https://www.eevblog.com/forum/metrology/nanovolt-design-challenge-build-and-show-your-own-nv-meter-in-256-days/?all)上的反应。我不敢说这完全鼓舞了我。 
另一方面，我花了几天时间在网上查阅资料，研究知名供应商的测试设备服务手册。可惜他们在上个世纪90年代初就不再向我们提供原理图了；但即使是这些材料也非常有助于了解这种仪表的要求以及实现它的方法。

## NVM设计，第1部分--设计要求
有了新的知识，我开始分析挑战要求。

> 应具备机载本地电源调节功能。预计应提供单一的通用直流电源（+9至+24 VDC）或110/220VAC主电源输入接口。

好吧，我想我可以做到这一点。另一方面，任何合理的市电电压表都必须有一个隔离的PSU部分，为输入分频器/放大器和ADC供电，这样测量电位就可以与所有用户和通信IO的数字部分无关--需要接地或接近该电位。
这需要直流电或交流电，但它可以通过让一个PSU在适当的直流电压下工作(12V听起来像是一个很好的起点)并连接一个小型AC/DC SMPS来从市电中供电来结合。

> 提供±100 uV或以下的直流电压测量范围，包括±1V和±10VDC范围。

这种方式看起来很简单，但在相同的插孔上同时输入10V和100uV意味着要么切换输入放大器，要么在信号路径中插入分压器，最好是通过继电器。一些较旧的纳米电压表(Keithley Model 181)有两个不同的输入--一个用于更高的范围，另一个带有低TEMF连接器用于敏感范围。

> 至少有两个用户可访问的输入通道，用于测量信号。

哦，我的天，还有一个继电器。继电器很好，但当继电器从线圈功率中发热时，由于触点上产生的热电压(TEMF，热电动势的缩写)，可能会给信号带来偏移误差。这些电压可能在几微伏特到纳伏左右，这在设计中绝对需要考虑。
TEMF是纳伏特计的主要敌人，这个首字母缩略词将在后面的文本中使用几次。

> 具有低热连接接口，以最大限度地减少热电动势寄生误差。

再说一遍，我告诉过你。
  
> 为每个读数提供至少5½位的分辨率。

听起来很合理。我做过一些大规模的ADC项目，比如[电压表](https://www.eevblog.com/forum/metrology/diy-6-5-digit-voltmeter/)和[伏特欧姆表](https://www.eevblog.com/forum/metrology/diy-6-digit-handheld-volohmmeter/msg2978912/#msg2978912)，所以也许我可以回收一些东西，也可以带来一些新的东西。我认为商业sigma-delta A-D转换器也可以完成这项工作，但DIY ADC肯定需要更多。

> 能够在至少0.1-10 Hz的带宽下，以至少10 nV的分辨率和优于30 nV的噪声将输入直流信号数字化。

更多的数字要求是，10Hz带宽下的30nVP-P并不是一个非常宽松的要求--像Keithley 181型这样的老式仪表无法满足这一要求，目前的型号一般。

> 具备 autozero 功能，可校正静态偏移。

这是一个合乎逻辑的要求。我将投入更多努力，引入自动校准功能。

> 具备电隔离模拟前端，隔离电阻对地/机壳的值优于10 GΩ。

这也是我之前提出的建议。

> 设备应集成ADC（任何类型）。

这很可能将该项目框定为一个独立的工作模式。

> 具有良好的长期稳定性和使用经过预热的直流电压参考源（LM399、LTZ1000或带有预热的LTFLU）。

无论如何，我不会考虑使用比LM399（或ADR1399）更差的东西。

> 提供RJ45以太网和/或IEEE-488 GPIB接口，用于与外部世界/外部设备进行通信。

说得有道理。不过，USB确实更简单。

> 总输入功率为40W（适合在电池供电下进行敏感实验）。

你肯定不希望你的纳伏特计消耗超过40W的功率。40W会产生相当多的热量，而且在不引入更多TEMF误差的情况下散发热量并非易事。

> 该设备应能作为独立设备全面运行（例如，不应附加调试器或外部设备以使其工作）。

好的，公平。

经过一点优化，我想出了这个框图。
![框图](/media/block.png?raw=true)
这基本上是为了满足上述要求而完成的，我添加了一些刺激性的部分以增加趣味性。
来自两个输入连接中的任何一个的输入都是通过一个输入多路转换器来选择的。此外还有一个将在后面讨论的第三个输入。这个多路转换器将选定的通道传递给一个低噪声放大器（LNA）进行放大，然后通过另一个多路转换器再送入主放大器。主放大器的输出被送至ADC。该ADC的标称输入范围为10V，因此，在配备LNA的情况下，基本范围是10mV（10mV x 1000 = 10V）。为了获得更灵敏的范围，主放大器可以选择切换成x1（直通）、x10和x100增益模式，从而额外提供1mV和100uV的范围。
当LNA被旁路时，输入信号被直接送入主放大器，从而能够覆盖10V、1V和100mV的量程，无缝涵盖100uV至10V的输入范围。这已然相当于一个纳伏特计了，但我又添加了两个模块——首先是简单的低通滤波器（也称为LPF），以降低噪声，尤其是在敏感量程上。另一个模块是自动校准块，用于确定两个放大器的增益。理想情况下，该仪表只需知道其板载的7V参考电压，就能自动推导出较低量程，而无需校准/调整，并且在分压器中的电阻器和放大器因老化或温度变化而漂移后仍能保持精度。
电路的整个上部部分被置于一个隔离屏障之后，以将输入端子与电源电位（无论是外部直流电还是市电）隔离开来。下部部分主要由电源供应单元和数字电路组成，包括用户输入输出接口以及诸如以太网和USB之类的通信通道。为了增添趣味性，我还纳入了GPIB作为低优先级子项目。

## NVM设计，第2部分 – 分而治之

设计这样的仪器，尤其是在DIY基础上，需要在机械设计和电气设计之间进行大量的来回权衡。我可以想象出这个仪器会有多么庞大（比如，其占地面积大概相当于A4纸大小），同时我也知道必须尽可能地塞下所有部件。 选择更大的外壳将赋予我更大的自由度和其他好处（比如更容易散发热量，有助于抵御TEMF），但会大到不切实际。找到合适的外壳并不容易——起初我曾考虑使用我在[DIY新加坡管理大学](https://github.com/jaromir-sukuba/J-SMU)项目中用过的那款G756，但我在这里更偏好金属外壳——因为这样可以屏蔽电气干扰，而使用钢制外壳甚至还能在一定程度上屏蔽磁场干扰。金属还有助于散热。最后我选择了Modushop的1EP802825。

那是研究电气领域的正确时机。接地部分和浮动部分（由隔离屏障隔开）必须在子外壳中物理分离（至少需要两个 PCB），为了更容易调试和修改电路，我决定将浮动部分分成两个 PCB。一个将包含 FPGA 控制、基准和 ADC，而另一个将由放大器和 ACAL 电路组成。由于外壳高 80 毫米，因此通过排针和公制垫片将至少两个 PCB 堆叠在一起没有问题。
因此，两个 PCB 用于浮动部分，一个用于接地部分。必须以某种方式安装背面连接器 - 在这里我添加了另一个 PCB。由于机械原因，前面板按钮也需要一个 PCB，这导致总共有 5 个 PCB。我用人名命名 PCB 并赋予它们功能：

**Bart** – 我感觉这个项目会有些棘手，而且会遇到一些问题。它包含LNA、主放大器、ACAL分频器和MUX。
**Homer** - 最大型的PCB， 包含FPGA、ADC、参考电路。与巴特密切相关。
**Lisa** - 通信板，后板 PCB
**Meggie** – 最简单的PCB，仅用于放置按钮。
**Marge** - 包含PSU，以供电给所有其他PCB以及数字电路。

在粗略地将电子部分划分成基本模块后，我转而进行机械设计。当我完成电路图文件的第一版草图时，已经收到了外壳，这样我就可以着手处理更实际的细节了。与仅仅研究3D文件（如果有的话）相比，有了实际的外壳在手，更容易直观地想象潜在的问题（如果真有的话）。在电路分隔方面，我选择了两个薄金属小外壳。
![内部金属部件](/media/mparts.png?raw=true). 右侧较小的部分容纳模拟电路，左侧较大的部分则容纳接地电路——为了留出空间给背面的PCB板，这部分设计得较短。
我在外壳上设计了一组孔洞，以便通过公制间隔件来安装PCB，而现在由于存在物理限制，我重新回到了PCB设计阶段。


## NVM设计，第3部分 - 电路操作的选定细节
在这一节中，我将讨论该仪器的一些精选设计选择。
#### LNA (Bart 板)
我对LNA进行了几次设计迭代，大约花了我一半的开发时间。我尝试了直流耦合JFET放大器、直流操作用斩波器配置的交流耦合JFE放大器以及并行放大器。并行配置给我带来的头痛最小，尽管使用了疯狂数量的组件，但它毕竟没有那么贵。作为同类中最好的，IF3602 JFET既昂贵又存在巨大的参数扩散问题，这使得它们成为一个相当昂贵的解决方案。市场上有更便宜的JFET，但它们的噪声参数意味着更多的并行片段——这会带来问题，例如分仓和匹配。更多的晶体管或更少的低噪声类型也会带来更多的栅极电容，需要更多的电路支持来减少其影响。将放大器封装在斩波器配置中会带来更多问题需要解决——例如，我必须处理输入电流和温度梯度增加电压偏移的问题。很可能所有这些问题都可以用更多的时间和精力解决，并且可以制造出比我目前的NVM更低噪声和漂移的低噪声放大器，但在某个时候，我决定走另一条路，用大规模并行现成的放大器构建了低噪声微波放大器。集成的自动零/斩波开关确实有更好的温度稳定性和输入电流，所以在搜索和比较后，我选择了微芯的MCP6V51，因为它具有非常好的价格/性能比。在 10Hz 带宽下，典型的输入噪声电压指定为 210nV ，我通过首先构建一个35片放大板来实验验证了这一点。
![Amp35](/media/amp_t1.jpg?raw=true)
这些噪声参数与数据表中的值相符，这使我有了继续前行的信心。根据计算，我需要至少50个MCP6V51器件才能达到30nV p-p的标准，因此我决定选用100个器件，以10x10的矩阵排列，如图所示。
![LNA 图表](/media/amp.PNG?raw=true)
第一阶段增益块（由10个并联的非反相放大器组成）中的每一个都被送入第二阶段的求和放大器，而所有10个第二阶段的放大器则被求和，以形成一个第三级、也是最终的放大器，其整体增益为1000。
最后一个级联放大器还被用于注入一个电压，以抵消LNA的偏移电压。 巴特电路板上设有DAC及其放大器（U119和U120）就是为了这个目的。DAC的第二通道被设计用于补偿输入电流——通过向LNA输入注入相反方向的电流。我测量的未补偿电流约为2纳安，而在我当前的硬件中，注入电阻器并未被安装在电路板上。通过利用这一特性，我预计电流将远低于100pA。
LNA会将地电流注入电路的接地网络中，而该电流取决于输入电压（进而也影响输出电压）。
地电流可能导致电路的地电位之间出现不必要的电压偏移，尤其是在高增益情况下。为了抵消这种地电流，使用 U121 设计的放大器被设置成向地端注入相反极性的电流，注入区域即为 LNA 所驻留的地方。
巴特板有四层结构，内部层为接地网，这既出于电气考虑，也出于热管理考虑。
#### ADC (Homer board)
该ADC属于积分型、电荷平衡类型，带有剩余积分器电压读数。
SN74LV4053 用于积分器电流控制，该积分器属于经典的由两个运算放大器组成的复合类型。FPGA 在这里承担了多项任务，除了协调 ADC 周边操作外，它还提供了隔离串行链路与用于切换继电器、多路复用器及模拟滤波器的多个数字输出之间的接口，并负责启动时序以确保 PSU 的平稳启动。
我根据 Solartron 7081 测量了 ADC 的 INL 作为参考。0-10V 电压扫描由 DIY 精密电压源（LTZ1000A基准电压源，AD5791B DAC）提供。实测INL图：
![ADC INL 图表](/media/lina.png?raw=true)
如此程度的INL可能在这个应用中并非绝对必要，但我希望利用ACAL功能，而该功能在两个量程间的电压转换方面对ADC的INL有较高要求，因此我致力于追求良好的线性度，并花了一些时间进行优化。

#### PSU (Marge 板)
我对PSU的第一个想法是使用两个背靠背的 50Hz 变压器。一个将提供几个伏特（提供第一隔离屏障和接地基准），第二个将将其提升到适合+-16V和5V直流输出的水平。后来我用一个音频放大器电路来输入第二个变压器，省略第一个变压器。使用AF放大器（由适当的振荡器供电）来驱动变压器有几个优点——整个电路可以由单个直流电压供电，并且振荡频率可以调整，以在泄漏和效率之间找到一个很好的折衷。使用传统的线性放大器会给外壳带来太多的热损耗，所以我选择了便宜且容量丰富的TPS3116 D级放大器。振荡器信号——可以来自本地单个放大倍频振荡器或由MCU提供的放大信号——由一系列低通滤波器塑形，以便放大器接收低谐波含量的信号。
二次变压器被带到一个相当标准的稳压器组-LM317/337和7805。
我测量了隔离PSU段的地漏及其效率与驱动频率的函数关系。
![PSU 图表](/media/psu-freq.PNG?raw=true)
正如预期的那样，较低的频率也会带来较低的泄漏电流，但频率过低会导致效率在某些点上急剧下降。我选择了48Hz，在此频率下测量的泄漏电流远低于200nA p-p。在这个水平上，泄漏测量对附近的电场和传导干扰非常敏感。将测试装置封装在屏蔽盒中后，测量的泄漏电流降至40nA p-p，这表明之前的测量过于悲观了。我认为即使是40nA这个数字也过于悲观，并受到了屏蔽设置和我所使用的示波器的限制。为了获得更准确的测试结果，我可能需要一个更大的屏蔽笼以及一台电池供电的示波器，但我不想在这方面投入过多资源。
PSU设计为游戏带来了有趣的细节。在过载情况下，TPS3116将关闭负载驱动器。这听上去似乎无害，但在这种情况下可能是个问题——因为在通电后，参考信号是冷的，因此加热器在通电期间会消耗大量电流。雪上加霜的是，所有去耦/大容量电容器都被放电，进一步增加了通电时的电流峰值。这个峰值导致TPS3116短暂关闭，然后试图重新启动负载，结果导致同样的巨大峰值，周而复始。
为了缓解这个问题，我们做了两个修复:
 - PSU驱动从较高频率开始，然后逐渐（在数秒时间内）下降至最终的48Hz值。隔离次级电压的上升速度要慢得多，从而确保电路能够平稳启动。
 - 电压参考加热电流（在未处理的情况下会产生大电流峰值）以及LNA电源电压将被保持，直到FPGA电源稳定后的10秒后，届时加热电流将被激活，而LNA电源将在两秒后开启。

## 机械部件
虽然该外壳以Modushop外壳为中心，但还需要几个额外的机械部件。

#### 参考封面
这个由两部分组成的3D打印组件能够防止空气在ADR1399参考器件周围流动，从而在某种程度上降低其噪音。
![Ref cover](/media/refcover.jpg?raw=true)
![Ref cover](/media/refcover2.jpg?raw=true)

#### 丽莎板架
这个3D打印部件使丽莎板保持在背板上的正确位置。这个3D打印部件使丽莎板保持在背板上的正确位置。
![Back holder](/media/backpcb.jpg?raw=true)
![Back panel](/media/backpanel.jpg?raw=true)

#### LNA cover
这个3D打印组件提供了LNA板区域与气流之间的绝缘。
![LNA cover](/media/lnacover.jpg?raw=true)
![LNA cover 2](/media/lnacover2.jpg?raw=true)
这种读数上的影响程度出乎我的意料。这里有两幅短波输入测量的图表，一幅有盖，一幅没有盖，裸露的LNA的均方根噪声电压几乎是两倍之高。
![LNA cover 图表](/media/lnacover_graph.PNG?raw=true)

#### Side PCB
原始的模度商店外壳是通过自攻螺钉固定在外壳侧金属片上的。我不喜欢这种方式，因此我在原始孔位上钻了直径为3.5毫米的孔，并安装了一个专门的机械PCB，上面除了孔和铜箔平面外别无他物，以便焊接M3螺母。这个PCB将内部底盘和外护板保持在同一块板上。我认为，如果用同样尺寸的厚度大于3毫米的铝材制成，并在其上钻出和攻出相应孔位，那么这个部件的做工应该会更好，但就目前而言，这个PCB似乎也能正常工作。
![Side PCB](/media/bok2.jpg?raw=true)

#### 推按钮杆
这是一个由三部分组成的3D打印组件，用于将主开关轴延伸至前面板。
待处理图片。

#### 前面板结构
显示屏盖被环氧树脂固定在前面板的切口中，显示屏则通过螺栓固定在梅吉板上，而该板又被螺栓固定在正面面板上。
透明塑料切割图的待办事项
![带有金属部件的附件](/media/frontpcb.jpg?raw=true)

#### 内部构造细节
![带有金属部件的附件](/media/enc_1.jpg?raw=true)
无需顶盖即可完成内部结构。
![覆盖](/media/covers.jpg?raw=true)
施工照片的集锦在Imgur画廊中。 [这里](https://imgur.com/a/fnK1Evj)

## NVM 使用
#### 本地接口
![前方面板](/media/fpanel.png?raw=true)
13个按键用于仪器操作，外加2行共20个字符的真空荧光显示屏。
启动后，仪表进入默认（测量）模式，从 EEPROM 读取设置。典型显示布局：
![显示例子](/media/disp.png?raw=true)
第一行以明显的方式显示测量的电压和范围。
此示例中的第二行表示以下状态：

CH1 - 选定的通道1。可以是1或2。

Z0 - 零函数（见下文）在此范围内未激活。可能为0或1。

10NPLC - 在电源线周期内进行ADC整合的时间倍增。可以是1、2、5、10或20。

ETH1 - 已连接以太网，并通过DHCP提供IP地址。可以是0或1。

按钮功能:  
**输入** – 通过点击此按钮，该仪器会在4引脚LEMO连接器上的输入1和输入2之间切换。

**ZERO** – 该功能可实现测量值的归零（通过减去在启用该功能时测得的恒定电压偏移值）。每个量程都有其偏移值，且与其他量程的偏移值无关。按下第二个按钮可禁用指定量程的归零功能。

**FILT** - 按下此按钮可显示模拟滤波器、数字滤波器和 NPLC 设置。按钮的每次点击都会将焦点移动到下一个设置（通过按 UP/DOWN 控件更改值），第三次点击返回默认测量显示。 

**ACAL** - 按下此按钮将启动ACAL程序，并将校准常数保存到EEPROM存储器中。

**TRIG** - 本固件版本中未使用。
**STORE** - 本固件版本中未使用。
**RECALL** - 本固件版本中未使用。
**菜单** - 启用菜单。通过按下上箭头和下箭头键可在菜单项之间移动。输入用于编辑项值 - 编辑操作通过上箭头和下箭头键完成。通过 ESC 键可以退出菜单，通过 MENU 键可以保存并退出。
**AUTO** - 本固件版本中未使用。. 
**ENTER** - 除了在菜单功能中的功能外，在默认模式下按下 ENTER 键将显示仪器的 IP 地址（如果已连接到以太网）。再次按下 ENTER 键则返回默认状态。
**UP/DOWN** - 在菜单或筛选编辑中，它发挥着上述描述的功能，在默认模式下，它会选择更高或更低的测量范围。 

#### 远程接口
通过以太网接口，通过发出与SCPI兼容的命令，可以实现对仪器的远程控制。
\*IDN? - 返回仪器识别码
\*RST - 重置仪器  
\*CLS - 清除状态  
SYSTem:ERRor[:NEXT] - 系统错误列表
SYSTem:ERRor:COUNt? - 返回系统错误的数量。
SYSTem:VERSion? - 返回工具版本字符串
MEASure:VOLTage? - 返回所测电压的值。
CALibration:VREF - 单个浮点参数，设定7V参考电压值（这是ACAL流程的唯一输入）。
CALibration:VREF? - 返回7V参考电压的值。
CALibration:UNLock - 单个整数值参数，用于锁定（0）或解锁（1）对校准EEPROM的访问。
CALibration:SAVe - 如果对校准EEPROM的访问被解锁，此命令会将实际的校准数据保存到EEPROM中。
CALibration:ACAL - 启动ACAL过程  
SENSe:CHANnel - 单个整数值参数，用于设置通道 1 或 2。
SENSe:CHANnel? - 返回实际的通道号。
SENSe:RANGe - 单整数参数，设定范围 1（100uV）至 6（10V）。
SENSe:RANGe? - 返回实际范围编号。
SENSe:DFILter - 单个整数值参数，用于将数字滤波器设置为1、2、4、8、16、32或64个样本。
SENSe:DFILter? - 返回数字滤波器设置
SENSe:AFILter - 单个整数值参数，用于设置模拟滤波器是否开启（0）或关闭（1）。
SENSe:AFILter? - 返回模拟滤波器设置
SENSe:DIGits - 单整数参数，用于设置显示的位数 - 3 到 6
SENSe:DIGits? - 返回显示的位数。
SENSe:NPLC - 单个整数值参数，用于将 NPLC 周期内的 ADC 积分周期设置为 1NPLC(0)、2 NPLC(1)、5NPLC (2)、10NPLC(3)或 20NPLC(4)。
SENSe:NPLC? - 返回ADC积分周期。  
SENSe:AZero - 单个整数值参数，用于设置ADC自动归零功能（0表示关闭，1表示开启）。
SENSe:AZero? - 返回ADC自动归零设置。
SYSTem:BEEPer - 单个整数值参数，用于设置蜂音器关闭（0）或开启（1）。
SYSTem:BEEPer? - 返回蜂音器状态

NVM完全通过ACAL功能进行了校准。为此，在运行ACAL功能之前，需要在校准内存中设置其参考电压。该值只能通过远程接口及其“CALibration:VREF”命令访问。如果校准内存中的参考值超出6.95-7.3V的范围，将默认为7.05V。目前，单独的区间校准功能尚不支持，但未来固件更新中可能会加入这一功能。.

## NVM项目目标
在此部分中，我将讨论此仪器的性能以及项目目标。
#### 噪声
该项目的主要标准是在最低电压范围内实现低噪声。为了评估这一点，我记录了下述条件下的20秒短路输入测量值：100uV范围，无自动归零功能，2NPLC（积分时间40mS）和10Hz模拟滤波器。
![Noise graph](/media/noise.png?raw=true)
噪声低于25nV p-p。
#### 稳定性
我大致记录了9个小时的数据，采用了短采样输入，同时记录了环境温度。仪表设定为10NPLC，自动归零已开启，模拟滤波器已打开。我将数据分割成每段64秒长的小块，进行平均处理后用作数据点。我尝试控制房间温度以获得一些变化。
![Longer noise graph](/media/lnoise.png?raw=true)
没有明确的温度依赖性。我解读的数据表明，对温度变化的敏感度可能比仪器的温度系数更为显著。
#### 线性
我使用Keithley 2010作为参考仪表，测得了相同的NVM INL值。
![NVM INL graph](/media/linn.png?raw=true)
我相信这处于6,5位数仪器的可接受范围内。
#### 带宽和正常模式抑制
我测量了ADC转换函数，输入信号为幅度为1Vp-p的正弦波，采样频率从1Hz逐渐提升至80Hz。仪表设置为2NPLC，无自动归零功能，模拟滤波器开启，量程为10V。
![Frequency response graph](/media/freq.png?raw=true)
相应的 -3dB 带宽在 9 到 10Hz 之间，正常模式抑制在 25Hz、50Hz 和 75Hz 处约为 -90dB。
#### 使用Keithley 260电压源提供各种电压作为输入。
量程设定为 20NPLC，自动归零已开启，模拟滤波器已开启，数字滤波器=2，量程为 100uV，步长为 10uV。该源已进行大规模修复，但已失去校准——不过作为测试源来评估 NVM 的线性度和稳定性表现良好。
![10uV steps graph](/media/steps10uv.PNG?raw=true)
同样适用于1uV的步长。请注意，由于Keithley 260源上的接触不良或电阻问题，缺少10uV的步长。
![10uV steps graph](/media/steps1uv.PNG?raw=true)
#### 响应10uV输入阶梯信号，并调整不同的数字滤波器设置。
仪表设置为20NPLC，自动零点开启，模拟滤波器开启，100uV范围。K260在输入端诱发10uV阶跃，观察不同数字滤波器设置下的响应时间。
![10uV steps graph](/media/dfilter.PNG?raw=true)
在这里，作为数字滤波器使用的箱式平均响应非常典型。.

#### 竞赛目标的实现。
现在回到比赛电话：

> 应具备机载本地电源调节功能。预计应提供单一的通用直流电源（+9至+24 VDC）或110/220VAC主电源输入接口。

是的，它既适用于DC 12V电源，也适用于230VAC电源。

> 提供直流电压测量范围 ±100 uV或以下，并包含 ±1V 和 ±10VDC 范围。

是的，输入范围是双极性的：100uV、1mV、10mV、100mV、1V和10V。

> 至少应有两个用户可访问的输入通道，用于测量信号。
> 拥有低热连接接口，以最大限度地减少热电磁干扰寄生误差。

是的，两个输入配有相当低端的TEMF LEMO连接器。

> 为每个读数提供至少5½位的分辨率。

6,5位数字已提供。

> 能够将输入直流信号数字化，分辨率至少为10nV，在至少0.1-10Hz的带宽内噪声小于30nV p-p 值。

在最低量程和6,5位读数时，分辨力为100pV，10Hz带宽内的噪声约为20-25nV p-p 值。

> 具备 autozero 功能，可校正静态偏移。

是的，提供自动归零和自动校准功能。

> 具备电隔离模拟前端，隔离电阻对地/机壳的值优于10 GΩ。

模拟部分被隔离。共模电流显然低于100nA p-p。

> 设备应集成ADC（任何类型）。

我使用了自己设计的集成多斜波ADC设计。

> 具有良好的长期稳定性和使用经过预热的直流电压参考源（LM399、LTZ1000或带有预热的LTFLU）。

我使用了ADR1399。目前还无法评估其长期稳定性。

> 提供RJ45以太网和/或IEEE-488 GPIB接口，用于与外部世界/外部设备进行通信。

RJ45以太网接口已提供，硬件也做好了与GPIB的对接准备。除此之外，板载还设有USB接口。

> 总输入功率为40W（适合在电池供电下进行敏感实验）。

当前耗电量为12W。

> 该设备应能作为独立设备全面运行（例如，不应附加调试器或外部设备以使其工作）。

该仪表无需任何外部设备即可运行。

#### 成本与组件可用性/可维修性
该仪器组件的总成本约为400欧元。我所使用的所有部件都是现成组件或易于订购的，只有电源变压器例外。该变压器是通过DIY方式制作的，但相信许多定制变压器制造商都能提供这样的变压器。
除此之外，我尝试使用通用性较强的元件封装——例如用于运算放大器的SOT23或SOIC8封装，用于晶体管的SOT23封装，大多数电阻器都有通用的封装脚位，能够适配MiniMELF（这是我选择的原因之一），使用1206或0805尺寸的电阻器，采用通用的显示接口等等。这样做是为了便于寻找替代元件，这在2022年是一个热门话题，因为元件危机正在影响专业以及业余电子产品的开发和生产。
尽管我尽了努力，但BOM清单中的一些组件很可能无法从常规供应商处获得，而在这方面很难设计出具有前瞻性的方案。

## 未来计划
该仪表硬件理论上能够执行一些功能，但目前尚未实现，我认为这是本项目未来工作的待办事项清单。
- 实现主要的频率同步测量。零交叉检测器已经安装在Marge板上，ADC支持由外部信号触发，因此这应该是固件支持的问题。
- 实现输入电流补偿。除一个高阻值电阻器外，所有部件都已安装在电路板上，因此，实现这一功能将再次成为固件处理的问题。
- 抛光前面板用户界面
- 完善SCPI命令实现，添加更多命令，并全面引入手动校准功能。
- 进行更复杂的触发操作，同时将数据记录到内存中，以充分利用所有前面板按钮。
- 对ACAL功能进行更多的探索和测试。就目前而言，它工作正常，但我认为在重复性方面可以做得更好。
- 寻找低功率运算放大器类型——这可以降低电流消耗，这在测试设备中总是受欢迎的。
- 为GPIB提供支持。虽然我并不那么需要GPIB， 但探索GPIB可能会成为一个有趣的项目。


## 此存储库中包含的文件
- **firmware**
	- **FPGA** - FPGA设计导入文件，莱迪思钻石项目
	- **STM32** - STM32在Marge板上的固件，属于STM32CubeIDE的工作空间的一部分。
- **hardware**
	- **PCB-design_files** - 设计文件，每个板对应一个目录，每个板都是一个Kicad v6项目。
	- **PCB-production_files** - Gerber和BOM数据，每个板对应一个目录。
	- **Schematics_pdf** - 易于阅读以PDF格式呈现的电路图，每个板对应一个目录，外加顶层互联示意图。
- **measurement_data** - 选定测量的源数据
- **media** - 用于此说明文件的图片和照片。
- **mechanical**
	- **3DP_back_panel_pcb_holder** - 组件，用于将丽莎板固定在背板。设计为单一部件，需印刷两次，其中一份需镜像。Freecad设计文件和STL文件。
	- **3DP_LNA_cover** - 该外壳旨在防止LNA受到空气紊流的影响。设计为单一部件，需要印刷两次，其中一份需进行镜像处理。包含Freecad设计文件和STL文件。
	- **3DP_pushbutton_assembly** - 将前面板按钮转移到主开关致动器。三个部件，每个各需一个，包含FreeCAD设计文件和STL文件。
	- **3DP_reference_cover** - 防止空气湍流引起电压参考。两个部分包含FreeCAD设计文件和STL文件，每个部分需要一次。
	- **acryllic_display_cover** - 显示屏盖框架采用灰色丙烯酸树脂切割。
	- **metal_parts_internal** - 外壳内部金属零件的设计文件和制造文件。5个零件:四个钣金(厚度为1mm)部件，一个2mm铝制平板部件。每个零件需要一次。
	- **PCB_back_panel** - 背板，在KICAD中设计为PCB。我让他们用FR4制造，但铝板也可以选择。
	- **PCB_front_panel** - 前面板，在KICAD中设计为PCB。我让他们用FR4制造，但铝板也可以选择。
	- **PCB_side_panel** - 在KICAD.FR4材料中设计为PCB的侧板，如果重新填充，铝可能也是如此。外壳需要两块。
	
## 重新开始
这个项目充满了乐趣和探索，但也有一个副作用，那就是获得了一个纳伏特表。我试图在业余爱好的预算范围内把它做得尽可能好，代价是既不便宜也不容易电路。这让我产生了一个想法，那就是挑选这个仪器的优点，以某种方式放宽设计标准，用更短更便宜的BOM来制作一个新项目。但这是另一个项目的主题。